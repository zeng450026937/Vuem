(function(t,e){"object"===typeof exports&&"object"===typeof module?module.exports=e(require("vue")):"function"===typeof define&&define.amd?define([],e):"object"===typeof exports?exports["Vuem"]=e(require("vue")):t["Vuem"]=e(t["Vue"])})(window,function(t){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(e,n){e.exports=t},function(t,e,n){"use strict";n.r(e);var r=n(0),o=n.n(r);function i(t){if(!Array.isArray(t))throw new TypeError("Middleware stack must be an array!");return t.forEach(function(t){if("function"!==typeof t)throw new TypeError("Middleware must be composed of functions!")}),function(e,n){var r=-1;return o(0);function o(i){if(i<=r)return Promise.reject(new Error("next() called multiple times"));r=i;var u=t[i];if(i===t.length&&(u=n),!u)return Promise.resolve();try{return Promise.resolve(u(e,o.bind(null,i+1)))}catch(a){return Promise.reject(a)}}}}function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function c(t,e,n){return e&&a(t.prototype,e),n&&a(t,n),t}var s=function(){function t(){u(this,t)}return c(t,[{key:"toJSON",value:function(){return{ns:this.ns,method:this.method,payload:this.payload}}}]),t}();function f(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function h(t,e,n){return e&&l(t.prototype,e),n&&l(t,n),t}var p=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];f(this,t),this.ns=e,this.middleware=[]}return h(t,[{key:"match",value:function(t){return!this.ns||this.ns===t}},{key:"use",value:function(t){if("function"!==typeof t)throw new TypeError("middleware must be a function!");return this.middleware.push(t),this}},{key:"register",value:function(t,e){var n=this;if("undefined"===typeof e)return e=t,t=null,this.use(e);var r=function(r,o){return!1===r.ns||n.ns.startsWith(r.ns)?r.method!==t?o():e.call(n.vm,r,o):o()};return r.method=t,this.use(r)}},{key:"callback",value:function(){var t=this;return function(e,n){if(!1!==e.ns&&!t.match(e.ns))return n?n():Promise.resolve();e.model=e.layer=t,e.vm=t.vm||e.vm;var r=i(t.middleware);return r(e,n)}}},{key:"dispatch",value:function(t,e,n){return n=n||this.createContext(),n.method=t,n.payload=e||{},this.callback()(n)}},{key:"createContext",value:function(){var t=new s;return t.layer=this,t.ns=this.ns,t}}]),t}();function y(t){return y="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},y(t)}function d(t,e){return m(t)||v(t,e)||b()}function b(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function v(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var u,a=t[Symbol.iterator]();!(r=(u=a.next()).done);r=!0)if(n.push(u.value),e&&n.length===e)break}catch(c){o=!0,i=c}finally{try{r||null==a["return"]||a["return"]()}finally{if(o)throw i}}return n}function m(t){if(Array.isArray(t))return t}function w(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function g(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function k(t,e,n){return e&&g(t.prototype,e),n&&g(t,n),t}function O(t,e){return!e||"object"!==y(e)&&"function"!==typeof e?j(t):e}function j(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function x(t,e,n){return x="undefined"!==typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=P(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(n):o.value}},x(t,e,n||t)}function P(t,e){while(!Object.prototype.hasOwnProperty.call(t,e))if(t=_(t),null===t)break;return t}function _(t){return _=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},_(t)}function E(t,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&S(t,e)}function S(t,e){return S=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},S(t,e)}var $=o.a.config.optionMergeStrategies;$.middleware=$.methods,$.subscribe=$.methods;var T,C=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return w(this,e),t=O(this,_(e).call(this,n)),t.root=null,t.parent=null,t.submodel={},t.mixins=[],t.data={},t.computed={},t.watch={},t.trigger={},t.vm=null,t}return E(e,t),k(e,[{key:"initialized",value:function(){return!!this.vm}},{key:"mount",value:function(t,n){if(!(n instanceof e))throw new TypeError("model must be an instance of Model");return this.submodel[t]&&console.warn("already has model for ".concat(t)),n.ns=this.genNS(t),n.parent=this,n.root=this.root,this.submodel[t]=n,this}},{key:"model",value:function(t){if(!t)return this;var n=this.submodel[t];return n||(n=new e,this.mount(t,n)),n}},{key:"up",value:function(){return this.parent||this}},{key:"provide",value:function(t,e){return t&&"undefined"===typeof e&&(this.mixins.push(t),t=null),t?(this.computed[t]&&console.warn("duplicate provided key"),"function"===typeof e?this.computed[t]=e:this.data[t]=e,this):this}},{key:"hook",value:function(t,e){return this.initialized()?(this.vm.$watch(t,e),this):(this.watch[t]=this.watch[t]||[],this.watch[t].push(e),this)}},{key:"subscribe",value:function(t,e){var n=this;return this.initialized()?(this.vm.$root.$on(t,function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return e.apply(n,r)}),this):(this.trigger[t]=this.trigger[t]||[],this.trigger[t].push(e),this)}},{key:"broadcast",value:function(){var t;if(this.initialized())return(t=this.vm.$root).$emit.apply(t,arguments),this;console.warn("broadcast can only be used when initialized")}},{key:"genNS",value:function(t){var e=t;return!1!==this.ns&&(e="".concat(this.ns,".").concat(t)),e}},{key:"genVM",value:function(t){return new o.a({parent:t,mixins:this.mixins,data:this.data,computed:this.computed,watch:this.watch})}},{key:"init",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.initialized()||e){this.vm&&(this.middleware=this.middleware.filter(function(t){return!t.method}));var n=Object.keys(this.submodel);n.forEach(function(e){t.data[e]=t.data[e]}),this.vm=this.genVM(this.parent&&this.parent.vm);var r=this.vm.$options,o=r.middleware,i=r.subscribe;return o&&Object.keys(o).forEach(function(e){return t.register(e,o[e])}),i&&Object.keys(i).forEach(function(e){return t.subscribe(e,i[e])}),Object.entries(this.trigger).forEach(function(e){var n=d(e,2),r=n[0],o=n[1];o.forEach(function(e){return t.subscribe(r,e)})}),n.forEach(function(e){var n=t.submodel[e];n.init(),t.use(n.callback()),t.data[e]=n.vm}),this}}},{key:"match",value:function(t){return x(_(e.prototype),"match",this).call(this,t)||t.startsWith(this.ns)||this.ns.startsWith(t)}},{key:"dispatch",value:function(t,n,r){var o=-1;t&&(o=t.lastIndexOf(".")),"undefined"===typeof r&&-1!==o&&(r=t.substring(0,o),t=t.substring(o+1));var i=this.createContext(r||!1);return x(_(e.prototype),"dispatch",this).call(this,t,n,i)}},{key:"createContext",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.ns;t&&this.ns&&!t.startsWith(this.ns)&&(t="".concat(this.ns,".").concat(t));var n=x(_(e.prototype),"createContext",this).call(this);return n.model=this,n.vm=this.vm,n.ns=t,n}}]),e}(p);function M(t){return M="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},M(t)}function R(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function z(t,e){return!e||"object"!==M(e)&&"function"!==typeof e?J(t):e}function A(t,e,n){return A="undefined"!==typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=V(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(n):o.value}},A(t,e,n||t)}function V(t,e){while(!Object.prototype.hasOwnProperty.call(t,e))if(t=W(t),null===t)break;return t}function W(t){return W=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},W(t)}function D(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function N(t,e,n){return e&&D(t.prototype,e),n&&D(t,n),t}function q(t,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&I(t,e)}function I(t,e){return I=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},I(t,e)}function J(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}n.d(e,"default",function(){return L}),n.d(e,"Model",function(){return C}),n.d(e,"Layer",function(){return p});var L=function(t){function e(){var t;return R(this,e),t=z(this,W(e).call(this)),t.root=J(J(t)),t.d={},t.env="production",t}return q(e,t),N(e,null,[{key:"install",value:function(t){T&&T===t||(T=t,T.mixin({beforeCreate:function(){var t=this,n=this.$options,r=n.kom||n.parent&&n.parent.$kom;if(r){var o=r instanceof e;if(!o)return console.warn("only kom is accepted.");r.init(),this.$kom=r,this.$model=r.vm,this.$dispatch=r.dispatch.bind(r),this.$broadcast=r.vm.$emit.bind(r.vm),this.$subscribe=r.vm.$on.bind(r.vm),this.$unsubscribe=r.vm.$off.bind(r.vm);var i=n.subscribe;i&&(this._subscribe={},Object.keys(i).forEach(function(e){var n=t._subscribe[e]=i[e].bind(t);t.$subscribe(e,n)}));var u=n.sketch;if(u){var a=u.ns,c=u.props,s=void 0===c?[]:c,f=r.vm;a&&(f=a.split(".").reduce(function(t,e){return t[e]},f)),s.forEach(function(t){n.computed[t]={get:function(){return f[t]},set:function(e){f[t]=e}}})}}},beforeDestroy:function(){var t=this,e=this.$options,n=e.kom||e.parent&&e.parent.$kom;if(n){var r=this._subscribe;r&&Object.keys(r).forEach(function(e){t.$unsubscribe(e,r[e])})}}}))}}]),N(e,[{key:"get",value:function(t){return this.d[t]}},{key:"set",value:function(t,e){this.d[t]=e}},{key:"createContext",value:function(t){var n=A(W(e.prototype),"createContext",this).call(this,t);return delete n.model,delete n.layer,n.kom=this,n}}]),e}(C)}])});